define(["zepto","template","lazyload"],function(e,t,n){function r(t,n){this.settings=t||null,this.content=e("#content")||null,this.tpl=n||null;if(this.content==null||this.settings==null||this.tpl==null)return!1;this.init();var r=this}return r.prototype={init:function(){this.btn=e("#morepage");if(this.btn.length<1)return!1;this.isPending=!1,this.isLimit=!1,this.scrolldelay=null,this.listenScroll();var r=this;this.btn.bind("autoload touchstart",function(){r.isPending=!0,r.showLoading(),e.ajax({url:r.settings.url+r.settings.param+"&num="+r.settings.current+"&size="+r.settings.size,dataType:"json",timeout:3e3,success:function(i,s,o){r.isPending=!1;if(i.status==="ok")try{function u(e){var t=parseInt(e),n=0,r=0,i="";t>=60&&(n=parseInt(t/60),t=parseInt(t%60),n>60&&(r=parseInt(n/60),n=parseInt(n%60)));var s=function(e){return(e<10?"0":"")+e};return r>0?i=s(r)+":"+s(n)+":"+s(t):i=s(n)+":"+s(t),i}if(i.content)for(var a=0;a<i.content.length;a++)i.content[a].duration=u(i.content[a].duration),i.content[a].duration=="00:00"&&(i.content[a].duration=""),/^\/attachment/.test(i.content[a].imageHor)?i.content[a].imageHor=i.domainMedia+i.content[a].imageHor:i.content[a].imageHor=i.dopoolMedia+i.content[a].imageHor,i.content[a].charge?i.content[a].charge="icon-vip":i.content[a].charge="";var f=e(t.compile(r.tpl)({list:i.content,domainStatic:i.domainStatic,subId:i.subId,version:i.version,pager:r.settings}));r.content.append(f),n.addImages(f.find("img.video-img")),r.showMore()}catch(l){throw l}r.settings.current>=r.settings.count&&(r.btn.hide(),r.isPending=!0),r.settings.current++},error:function(e,t,n){t==="timeout"?r.showMsg("获取内容超时，请稍候重新获取！"):r.showMsg("获取失败，请您稍后重试！"),setTimeout(function(){r.btn.trigger("autoload")},3e3)}})})},listenScroll:function(){var e=this;window.addEventListener("scroll",function(){clearTimeout(e.scrolldelay);if(e.isPending)return!1;e.scrolldelay=setTimeout(function(){document.body.scrollTop>(document.height||document.documentElement.offsetHeight)-window.innerHeight-10&&e.btn.trigger("autoload")},100)})},getData:function(){},showMsg:function(e){this.btn.find(".loading").html("<i></i>"+e),this.btn.addClass("loaderr")},showLoading:function(){this.btn.find(".loading").html("<i></i>加载中..."),this.btn.addClass("pending")},showMore:function(){this.btn.removeClass("pending")}},r});